#!/bin/python3

'''
Maps IP to port from an nmap greppable format
'''

import sys
import re

if len(sys.argv) != 2:
	print('Usage: port_puller gnmap_file')
	exit()

with open(sys.argv[1]) as fp:
    output = fp.read()
    output = output.split('\n')[2:-2]

    res = []
    for i, scan in enumerate(output):
        if 'Status' in scan:
            continue

        ip_address_pattern = r"\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}"
        ip_address = re.findall(ip_address_pattern, scan)[0]

        ports = scan.split('Ports: ')[1]
        ports = ', '.join([x for x in ports.split(', ') if 'open' in x])
        number_pattern = r"\d+(?=\/open)"

        # Search for numbers in the string using the regular expression
        ports = ','.join(re.findall(number_pattern, ports))

        res.append(f'{ip_address}:{ports}')

    res = list(set(res))
    for i in res:
        print(i)
